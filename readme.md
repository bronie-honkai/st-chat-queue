# 📜 SillyTavern Chat Queue (聊天队列)

![Version](https://img.shields.io/badge/Version-1.0.1-blue?style=flat-square) ![SillyTavern](https://img.shields.io/badge/SillyTavern-Extension-orange?style=flat-square)

**Chat Queue** 是一个为 [SillyTavern](https://github.com/SillyTavern/SillyTavern) 设计的高级自动化插件。

它不再局限于简单的“批量上传图片”，而是引入了**“聊天楼层” (Chat Floor)** 的概念。你可以预先编排好一系列包含**文本提示词**和**附件（图片/文档）**的发送队列，然后让 AI 按照你设定的顺序，全自动地与酒馆进行交互。

无论是进行连续的剧情演绎、批量处理图片分析，还是构建复杂的对话脚本，Chat Queue 都能助你一臂之力。🚀

---

## ✨ 核心功能 (Features)

*   **🏗️ 楼层化管理**：每个队列项都是一个独立的“楼层”，可以单独包含文本、附件，或者两者皆有。
*   **📂 批量导入**：支持拖拽上传或点击按钮批量选择文件，自动为每个文件生成独立楼层。
*   **📝 文本编辑模式**：内置行内编辑器，可随时修改每个楼层的 Prompt 文本。
*   **🖼️ 智能预览**：
    *   支持折叠/展开预览区，保持界面整洁。
    *   支持点击“眼睛”图标查看附件缩略图或长文本内容。
*   **📎 灵活挂载**：支持为现有的文本楼层追加附件，或替换现有附件。
*   **🖱️ 拖拽排序**：按住手柄即可随意调整发送顺序。
*   **⏯️ 智能控制**：在聊天输入框旁自动注入“开始/暂停”按钮，像播放音乐一样控制对话流。
*   **🎨 原生体验**：完全复刻 SillyTavern 原生 UI 风格（毛玻璃特效、侧边栏抽屉），无缝融入。

---

## 🛠️ 安装方法 (Installation)

### 方法 1：通过 URL 安装 (推荐)

1.  打开 SillyTavern。
2.  点击顶部菜单栏的 **扩展 (Extensions)** 图标 🧩。
3.  点击 **安装扩展 (Install Extension)** 按钮。
4.  在 **从 URL 安装 (Install from URL)** 输入框中，粘贴本仓库的链接：
    ```text
    https://github.com/bronie-honkai/st-chat-queue.git
    ```
5.  点击 **安装 (Install)**，安装完成后刷新页面即可。

### 方法 2：手动安装

1.  进入你的 SillyTavern 安装目录：`/public/scripts/extensions/`。
2.  在此处打开终端 (Terminal)，运行：
    ```bash
    git clone https://github.com/bronie-honkai/st-chat-queue.git
    ```
3.  重启 SillyTavern。

---

## 📖 使用指南 (User Guide)

### 1. 打开面板
插件安装成功后，你可以通过以下两种方式打开“聊天队列”侧边栏：
*   **顶部图标**：点击顶部导航栏新增的 **图层图标** (Layer Group)。
*   **魔法棒菜单**：点击输入框左侧的魔法棒 🪄，选择 **“附件文件队列”**。

### 2. 构建队列
你可以混合使用以下方式来填充你的发送队列：

| 操作 | 说明 |
| :--- | :--- |
| **拖拽文件** | 直接将图片/文档拖入面板的虚线区域，自动创建带附件的楼层。 |
| **➕ 添加文件** | 点击底部按钮，批量选择本地文件，自动创建楼层。 |
| **📝 新增楼层** | 点击底部按钮，创建一个**纯文本**的空楼层，适合插入旁白或指令。 |
| **📋 粘贴楼层** | 点击底部按钮，从剪贴板粘贴文本内容直接创建新楼层，无需手动输入。 |

### 3. 管理楼层 (Item Controls)
每个楼层项右侧都有三个功能强大的微型按钮，鼠标悬停可查看提示：

*   **👁️ 预览 (Preview)**
    *   点击后展开/折叠底部的预览区域。
    *   支持查看大图或阅读完整的 Prompt 文本。
*   **✏️ 编辑 (Edit)**
    *   进入“编辑模式”。将文本显示区变为输入框，允许你修改发送给 AI 的文字内容。
    *   点击“保存”生效，点击“取消”放弃修改。
*   **📎 附件 (Attach)**
    *   打开文件选择器。
    *   **智能逻辑**：如果楼层已有附件，则**替换**它；如果楼层是纯文本，则**添加**新附件。

### 4. 执行队列
当队列中存在待发送项目（状态为 `等待中`）时，聊天输入框（发送按钮旁）会出现控制按钮：

*   ▶️ **开始 (Play)**：开始自动发送。插件会上传附件、挂载文本，并触发酒馆的生成函数。等待 AI 回复完毕后，自动执行下一条。
*   ⏸️ **暂停 (Pause)**：当前消息发送完毕后暂停队列。

---

## ⚙️ 技术细节

*   **原生上传**：使用 `FormData` 和 SillyTavern 内部 API 进行文件上传，完美解决 403 权限问题。
*   **Generate 调用**：直接通过 `Generate('normal')` 触发生成，确保聊天记录中能正确显示用户发送的图片和文本（所见即所得）。
*   **加载顺序**：`manifest.json` 中设置了 `"loading_order": 2`，确保在酒馆核心脚本加载完毕后初始化，避免冲突。

---

## ❓ 常见问题 (FAQ)

> **Q: 这个插件和“批量上传”有什么区别？**
>
> A: 批量上传通常是一次性把图发完。而本插件是**“队列”**，它是一个个发的，发一张图 -> 等 AI 回复 -> 再发下一张。适合用来让 AI 逐个评价图片，或者进行连续剧情跑团。

> **Q: 发送时输入框里会有内容吗？**
>
> A: 会的。插件会自动把你设定的文本填入输入框，把图片挂载上去，然后点击发送。这和你在键盘上自己操作的效果是一模一样的。

---

## 🎉 更新日志 (Changelog)

### v1.0.18 (2025-12-27)

#### 新增功能
*   **📋 粘贴楼层按钮** - 在"新增楼层"按钮旁添加了"粘贴楼层"功能
    *   一键从剪贴板粘贴文本内容，自动创建新楼层
    *   支持快速导入长文本、复制的对话或任何剪贴板内容
    *   使用现代 Clipboard API，权限友好
    *   粘贴成功/失败时有相应的提示反馈

#### 改进
*   加快队列构建速度，特别是处理大段文本内容时
*   提升工作流效率，无需中间编辑步骤

---

### v1.0.17 (2025-12-27)

#### 新增功能
*   **📋 复制按钮** - 为每个队列项目添加了复制按钮，方便快速复制楼层内容到剪贴板
    *   点击复制图标即可一键复制文本内容
    *   支持复制空项目（显示占位符提示）
    *   成功/失败时有相应的提示反馈
    *   使用现代 Clipboard API，无需额外依赖

#### 改进
*   增强了用户交互体验，减少手动复制文本的步骤
*   按钮位置和样式与现有按钮保持一致，界面更加统一

---

## 📜 许可证 (License)

MIT License.
